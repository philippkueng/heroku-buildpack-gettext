#!/bin/bash

VERSION="0.19.8"
echo "-----> Install gettext v${VERSION}"

BUILD_DIR=$1
CACHE_DIR="$2/gettext"
INSTALL_PATH=".heroku/gettext"
INSTALL_DIR="$BUILD_DIR/$INSTALL_PATH"
PROFILE_DIR="$BUILD_DIR/.profile.d"

indent() {
    sed -u 's/^/       /'
}

printlog() {
    echo $1 | indent
}

run_silent() {
    $1 > /dev/null 2>&1
}


mkdir -p $CACHE_DIR
printlog "Cache directory: ${CACHE_DIR}"

if [ -d "${CACHE_DIR}/gettext-${VERSION}" ]; then
  printlog "Skip downloading and take it from the cache."
  cp -r "${CACHE_DIR}/gettext-${VERSION}" "gettext-${VERSION}"
else
  printlog "Downloading gettext"
  wget "http://ftp.gnu.org/pub/gnu/gettext/gettext-${VERSION}.tar.gz"

  printlog "Unpacking gettext"
  tar -zxvf "gettext-${VERSION}.tar.gz"
  cp -r "gettext-${VERSION}" "${CACHE_DIR}/gettext-${VERSION}"
fi

cd "gettext-${VERSION}"

if [ -f "${CACHE_DIR}/gettext-${VERSION}/configured" ]; then
  printlog "Skip the ./configure call and take already configured version from the cache."
else
  printlog "Configuring gettext"
  /bin/sh configure && touch "${CACHE_DIR}/gettext-${VERSION}/configured" && cp -r "gettext-${VERSION}" "${CACHE_DIR}/gettext-${VERSION}"
fi

if [ -f "${CACHE_DIR}/gettext-${VERSION}/made" ]; then
  printlog "Skip the make call and take already made version from the cache."
else
  printlog "Compiling gettext"
  make && touch "${CACHE_DIR}/gettext-${VERSION}/made" && cp -r "gettext-${VERSION}" "${CACHE_DIR}/gettext-${VERSION}"
fi

pwd
ls -la
env
which make
printlog "Installing gettext"
mkdir -p $INSTALL_DIR/bin
make install DESTDIR=$INSTALL_DIR/bin

mkdir -p $PROFILE_DIR
echo "export PATH=\$PATH:\$HOME/$INSTALL_PATH/bin/usr/local/bin" > $PROFILE_DIR/gettext.sh
echo "export LD_LIBRARY_PATH=\$LD_LIBRARY_PATH:\$HOME/$INSTALL_PATH/bin/usr/local/lib" >> $PROFILE_DIR/gettext.sh

# Exporting the PATH variable, so that buildpacks following after this can use gettext
BUILDPACK_DIR=$(cd $(dirname ${0:-}); cd ..; pwd)
echo "export PATH=\$PATH:$INSTALL_DIR/bin/usr/local/bin" > $BUILDPACK_DIR/export
echo "export LD_LIBRARY_PATH=\$LD_LIBRARY_PATH:$INSTALL_DIR/bin/usr/local/lib" > $BUILDPACK_DIR/export